CREATE DATABASE DBMATRICULAL

GO

USE DBMATRICULAL

CREATE TABLE ESTUDIANTES(
	ID_ESTUDIANTE INT IDENTITY(1,1) CONSTRAINT PK_ESTUDIANTES PRIMARY KEY,
	CEDULA_ESTUDIANTE VARCHAR(20) NOT NULL UNIQUE,
	NOMBRE_ESTUDIANTE VARCHAR(20) NOT NULL,
	PRIMER_APELLIDO_E VARCHAR(20) NOT NULL,
	SEGUNDO_APELLIDO_E VARCHAR(20),
	TELEFONO_ESTUDIANTE VARCHAR(8) NOT NULL,
	CORREO_ESTUDIANTE VARCHAR(25),
	FECHA_INGRESO DATE NOT NULL DEFAULT GETDATE(),
	ESTADO_ESTUDIANTE VARCHAR(3) NOT NULL DEFAULT 'ACT', --ESTADO DE ESTUDIANTE PUEDE SER ACTIVO O INACTIVO
	BORRADO_ESTUDIANTE BIT NOT NULL DEFAULT 0 --0 EQUIVALE A NO BORRADO, 1 EQUIVALE A BORRADO
)

--ALTER TABLE ESTUDIANTES ADD CONSTRAINT CHK_FECHAINGRESO_E
--CHECK(FECHA_INGRESO>=GETDATE())

ALTER TABLE ESTUDIANTES ADD CONSTRAINT CHK_ESTADO_E
CHECK(ESTADO_ESTUDIANTE in ('ACT','INA') 
and ESTADO_ESTUDIANTE = upper(ESTADO_ESTUDIANTE))

--

CREATE TABLE PROFESORES(
	ID_PROFESOR INT IDENTITY(1,1) CONSTRAINT PK_PROFESORES PRIMARY KEY,
	CEDULA_PROFESOR VARCHAR(20) NOT NULL UNIQUE,
	NOMBRE_PROFESOR VARCHAR(20) NOT NULL,
	PRIMER_APELLIDO_P VARCHAR(20) NOT NULL,
	SEGUNDO_APELLIDO_P VARCHAR(20),
	TELEFONO_PROFESOR VARCHAR(8) NOT NULL,
	CORREO_PROFESOR VARCHAR(25),
	FECHA_INGRESO_PROFESOR DATE NOT NULL DEFAULT GETDATE(),
	ESTADO_PROFESOR VARCHAR(3) NOT NULL DEFAULT 'ACT', --ESTADO DE PROFESOR PUEDE SER ACTIVO O INACTIVO
	BORRADO_PROFESOR BIT NOT NULL DEFAULT 0 --0 EQUIVALE A NO BORRADO, 1 EQUIVALE A BORRADO
)

--ALTER TABLE PROFESORES ADD CONSTRAINT CHK_FECHAINGRESO_P
--CHECK(FECHA_INGRESO_PROFESOR>=GETDATE())

ALTER TABLE PROFESORES ADD CONSTRAINT CHK_ESTADO_P
CHECK(ESTADO_PROFESOR in ('ACT','INA') 
and ESTADO_PROFESOR = upper(ESTADO_PROFESOR))

--
CREATE TABLE MATERIAS(
	CODIGO_MATERIA VARCHAR(10) NOT NULL CONSTRAINT PK_MATERIAS PRIMARY KEY,
	NOMBRE_MATERIA VARCHAR(120) NOT NULL,
	HORAS_TOTALES TINYINT NOT NULL DEFAULT 100,
	BORRADO_MATERIA BIT NOT NULL DEFAULT 0 --0 EQUIVALE A NO BORRADO, 1 EQUIVALE A BORRADO
)

--

CREATE TABLE MATERIAS_ABIERTAS(
	ID_MATERIA_ABIERTA INT IDENTITY(1,1) CONSTRAINT PK_MATERIAS_ABIERTAS PRIMARY KEY,
	CODIGO_MATERIA VARCHAR(10) NOT NULL,
	CEDULA_PROFESOR VARCHAR(20) NOT NULL,
	GRUPO TINYINT,
	CUPO TINYINT DEFAULT 20,
	ANIO SMALLINT,
)



ALTER TABLE MATERIAS_ABIERTAS ADD CONSTRAINT CHK_ANIO 
CHECK(ANIO is null or ANIO>=YEAR(GETDATE()))

ALTER TABLE MATERIAS_ABIERTAS ADD CONSTRAINT FK_MATERIAS_ABIERTAS_M 
FOREIGN KEY (CODIGO_MATERIA) REFERENCES MATERIAS(CODIGO_MATERIA)

ALTER TABLE MATERIAS_ABIERTAS ADD CONSTRAINT FK_MATERIAS_ABIERTAS_P 
FOREIGN KEY (CEDULA_PROFESOR) REFERENCES PROFESORES(CEDULA_PROFESOR)


CREATE TABLE HORARIOS(
	ID_MATERIA_ABIERTA INT NOT NULL,
	DIA CHAR(1) NOT NULL,
	HORA_INICIO TIME NOT NULL,
	HORA_FINAL TIME NOT NULL
	CONSTRAINT PK_HORARIOS PRIMARY KEY(ID_MATERIA_ABIERTA,DIA,HORA_INICIO,HORA_FINAL)
)


ALTER TABLE HORARIOS ADD CONSTRAINT CHK_DIA
 CHECK(DIA IN('L','K','M','J','V','S') and DIA = upper(DIA))

ALTER TABLE HORARIOS ADD CONSTRAINT FK_HORARIOS 
FOREIGN KEY (ID_MATERIA_ABIERTA) REFERENCES MATERIAS_ABIERTAS(ID_MATERIA_ABIERTA)


CREATE TABLE MATRICULAS(
	ID_MATRICULA INT IDENTITY(1,1) CONSTRAINT PK_MATRICULAS PRIMARY KEY,
	CEDULA_ESTUDIANTE VARCHAR(20) NOT NULL,
	FECHA_MATRICULA DATETIME NOT NULL DEFAULT GETDATE(),
	ESTADO_MATRICULA VARCHAR(3) NOT NULL DEFAULT 'ACT',
	OBSERVACIONES VARCHAR(250) 
)



ALTER TABLE MATRICULAS ADD CONSTRAINT CHK_ESTADO_M 
CHECK(ESTADO_MATRICULA='ACT' OR ESTADO_MATRICULA='INA')

ALTER TABLE MATRICULAS ADD CONSTRAINT FK_MATRICULAS 
FOREIGN KEY (CEDULA_ESTUDIANTE) REFERENCES ESTUDIANTES(CEDULA_ESTUDIANTE)




CREATE TABLE DETALLE_MATRICULAS(
	ID_MATRICULA INT NOT NULL,
	ID_MATERIA_ABIERTA INT NOT NULL,
	NOTA_FINAL DECIMAL(5,2) DEFAULT 0,
	ESTADO_DETALLE_MATRICULA VARCHAR(3) NOT NULL DEFAULT 'ACT'
	CONSTRAINT PK_DETALLE_MATRICULAS PRIMARY KEY(ID_MATRICULA,ID_MATERIA_ABIERTA)
)



ALTER TABLE DETALLE_MATRICULAS ADD CONSTRAINT CHK_ESTADOD 
CHECK(ESTADO_DETALLE_MATRICULA IN('ACT','RET','APR','REP'))

ALTER TABLE DETALLE_MATRICULAS ADD CONSTRAINT FK_DETALLE_MATRICULAS_DM
FOREIGN KEY (ID_MATRICULA) REFERENCES MATRICULAS(ID_MATRICULA)

ALTER TABLE DETALLE_MATRICULAS ADD CONSTRAINT FK_DETALLE_MATRICULAS_MA
FOREIGN KEY (ID_MATERIA_ABIERTA) REFERENCES MATERIAS_ABIERTAS(ID_MATERIA_ABIERTA)




